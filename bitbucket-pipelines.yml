image: node:8.11.3

pipelines:
  branches:
    master:
      - step:
          name: Build
          caches:
            - node
          script:
            # Copy SSH key so that we can pull additional submodules
            - mkdir -p /root/.ssh
            - cp id_rsa /root/.ssh/id_rsa
            - chmod 700 /root/.ssh/id_rsa
            - echo "Host bitbucket.org\n\tStrictHostKeyChecking no\n" >> /root/.ssh/config
            - npm install
            - npm run build
          artifacts:
            - Bundles/**
      - step:
          name: Push Bundle File & Version Tag
          script:
            # Get version number from package.json
            - declare -x VERSION=$(node -p -e "require('./package.json').version")
            - echo -e "Pipeline Build - ${BITBUCKET_BUILD_NUMBER}\nPackage Version - ${VERSION}\nCommit Hash - ${BITBUCKET_COMMIT}" > changes.txt
            - git add changes.txt
            - git add Bundles/lbreactcore.js
            - git commit -m "[skip ci] Updating changes.txt & latest bundle in lb-react-core repo"
            - git push origin $BITBUCKET_BRANCH
            # Create/Push tag to commit
            # if tag already exists, it does not retag
            - set +e # disables exiting if error occurs
            - git tag $VERSION
            - git push origin $VERSION $BITBUCKET_BRANCH
            - set -e
